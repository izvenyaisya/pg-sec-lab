# üê≥ Docker Testing –¥–ª—è pg-sec-lab

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
docker-compose up --build

# 2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Makefile
make test
```

## –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ

### üì¶ Docker Compose —Å–µ—Ä–≤–∏—Å—ã

1. **postgres** (–ø–æ—Ä—Ç 5432) - –¢–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: postgres / postgres
   - –ë–∞–∑–∞: testdb
   - –° —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

2. **postgres-prod** (–ø–æ—Ä—Ç 5433) - "–ü—Ä–æ–¥–∞–∫—à–Ω" –±–∞–∑–∞
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: produser / prodpass
   - –ë–∞–∑–∞: proddb
   - –° –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

3. **pg-sec-lab** - –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç 15+ —Ç–µ—Å—Ç–æ–≤
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç—ã

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### 1. –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
docker-compose up --build

# –†–µ–∑—É–ª—å—Ç–∞—Ç:
# ====================================
#    –ò–¢–û–ì–û–í–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
# ====================================
# –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:    15
# –£—Å–ø–µ—à–Ω—ã—Ö:        15
# –ü—Ä–æ–≤–∞–ª–µ–Ω–æ:       0
# –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞:  100.00%
```

### 2. –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –¢–æ–ª—å–∫–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
make generate

# –í—ã–≤–æ–¥:
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL...
# SQL —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: output/generated.sql

# –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫
make verify

# –¢–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
make analyze

# –ê–Ω–∞–ª–∏–∑ "–ø—Ä–æ–¥–∞–∫—à–Ω" –ë–î
make analyze-prod
```

### 3. –†–∞–±–æ—Ç–∞ —Å –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
make db-shell

# –í–Ω—É—Ç—Ä–∏ psql:
testdb=# \dt
testdb=# SELECT * FROM customers;

# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
make prod-db-shell
```

### 4. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º

```bash
# –í–æ–π—Ç–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
make shell

# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
/app # ./pg-sec-lab --help
/app # ./pg-sec-lab generate --policy policy.yaml
/app # ./pg-sec-lab analyze --dsn "postgres://..."
```

## Makefile –∫–æ–º–∞–Ω–¥—ã

```bash
make help              # –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
make build             # –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑
make test              # –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
make test-quick        # –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (–±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏)
make up                # –ó–∞–ø—É—Å—Ç–∏—Ç—å –ë–î
make down              # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å—ë
make clean             # –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
make logs              # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
make shell             # –í–æ–π—Ç–∏ –≤ shell
make db-shell          # –í–æ–π—Ç–∏ –≤ psql —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
make prod-db-shell     # –í–æ–π—Ç–∏ –≤ psql –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
make generate          # –ö–æ–º–∞–Ω–¥–∞ generate
make verify            # –ö–æ–º–∞–Ω–¥–∞ verify
make analyze           # –ö–æ–º–∞–Ω–¥–∞ analyze
make analyze-prod      # –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î
make results           # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
make status            # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
make benchmark         # –ë–µ–Ω—á–º–∞—Ä–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
make ci                # CI pipeline
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã (docker-test.sh)

1. ‚úÖ **–¢–µ—Å—Ç —Å–ø—Ä–∞–≤–∫–∏** - –ø—Ä–æ–≤–µ—Ä–∫–∞ `--help`
2. ‚úÖ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ stdout** - –≤—ã–≤–æ–¥ SQL
3. ‚úÖ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ —Ñ–∞–π–ª** - —Å–æ–∑–¥–∞–Ω–∏–µ generated.sql
4. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ SQL** - –Ω–∞–ª–∏—á–∏–µ CREATE ROLE, RLS, POLICY, GRANT
5. ‚úÖ **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü** - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
6. ‚úÖ **–ö–æ–º–∞–Ω–¥–∞ verify** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫
7. ‚úÖ **–ö–æ–º–∞–Ω–¥–∞ analyze** - –∞–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
8. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ JSON** - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç—á—ë—Ç–∞
9. ‚úÖ **–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SQL** - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫
10. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π** - —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–æ–ª–∏ –≤ –ë–î
11. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ RLS** - –≤–∫–ª—é—á–µ–Ω–∏–µ Row Level Security

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤

### –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

```
output/
‚îú‚îÄ‚îÄ generated.sql       # SQL-—Å–∫—Ä–∏–ø—Ç –ø–æ–ª–∏—Ç–∏–∫
‚îú‚îÄ‚îÄ report.json        # –û—Ç—á—ë—Ç –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
‚îî‚îÄ‚îÄ report-prod.json   # –û—Ç—á—ë—Ç –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–¥–∞–∫—à–Ω –ë–î

test-results/
‚îú‚îÄ‚îÄ summary.txt        # –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ verify-output.log  # –õ–æ–≥–∏ verify
‚îú‚îÄ‚îÄ analyze-output.log # –õ–æ–≥–∏ analyze
‚îî‚îÄ‚îÄ apply-sql.log      # –õ–æ–≥–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è SQL
```

### –ü—Ä–∏–º–µ—Ä generated.sql

```sql
-- Generated by pg-sec-lab
-- System: training-crm, Version: 1.0

-- Create roles
CREATE ROLE "analyst" NOLOGIN NOCREATEDB;
CREATE ROLE "support" NOLOGIN NOCREATEDB;
CREATE ROLE "reporting_app" LOGIN NOCREATEDB;
GRANT "analyst" TO "reporting_app";

-- Enable RLS on tables
ALTER TABLE "public"."customers" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "public"."customers" FORCE ROW LEVEL SECURITY;
CREATE POLICY "rls_select_customers" ON "public"."customers" 
  FOR SELECT USING (tenant_id = current_setting('app.tenant_id')::uuid);
...
```

### –ü—Ä–∏–º–µ—Ä report.json

```json
{
  "instance": {
    "version": "PostgreSQL 16.0 on x86_64",
    "settings": {
      "ssl": "off",
      "password_encryption": "scram-sha-256",
      "log_connections": "off"
    }
  },
  "roles": [
    {
      "name": "postgres",
      "login": true,
      "superuser": true,
      "bypassrls": true,
      "grants": []
    }
  ],
  "tables": [
    {
      "schema": "public",
      "name": "customers",
      "rls_enabled": true
    },
    {
      "schema": "public",
      "name": "orders",
      "rls_enabled": true
    }
  ],
  "findings": [
    {
      "severity": "high",
      "code": "SSL_DISABLED",
      "message": "SSL is disabled on this PostgreSQL instance"
    },
    {
      "severity": "critical",
      "code": "SUPERUSER_LOGIN",
      "message": "Role postgres is a superuser with login capability"
    }
  ]
}
```

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

```bash
# –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–æ–≤
make results

# –¢–æ–ª—å–∫–æ summary
cat test-results/summary.txt

# –¢–æ–ª—å–∫–æ findings –∏–∑ JSON
cat output/report.json | jq '.findings'
```

### –†–∞–±–æ—Ç–∞ —Å PostgreSQL

```bash
# –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü
make db-shell
\dt

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å RLS
SELECT relname, relrowsecurity 
FROM pg_class 
WHERE relkind = 'r' AND relrowsecurity = true;

# –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π
\du

# –ü–æ–ª–∏—Ç–∏–∫–∏
SELECT * FROM pg_policies;
```

### –ë–µ–Ω—á–º–∞—Ä–∫

```bash
make benchmark

# –í—ã–≤–æ–¥:
# –¢–µ—Å—Ç 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL
# real    0m0.543s
# 
# –¢–µ—Å—Ç 2: –ê–Ω–∞–ª–∏–∑ –ë–î  
# real    0m1.234s
```

## CI/CD –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### GitHub Actions

```yaml
name: Docker Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run tests
        run: make test
      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: |
            output/
            test-results/
```

### GitLab CI

```yaml
test:
  image: docker:latest
  services:
    - docker:dind
  script:
    - make test
  artifacts:
    paths:
      - output/
      - test-results/
```

## Troubleshooting

### PostgreSQL –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
docker-compose logs postgres

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å
docker-compose down -v
docker-compose up -d postgres
```

### –¢–µ—Å—Ç—ã –ø–∞–¥–∞—é—Ç

```bash
# –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
docker-compose logs pg-sec-lab

# –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
make shell
/app/docker-test.sh
```

### –ü–æ—Ä—Ç—ã –∑–∞–Ω—è—Ç—ã

```bash
# –ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä—Ç—ã –≤ docker-compose.yml
ports:
  - "15432:5432"  # –≤–º–µ—Å—Ç–æ 5432:5432
```

### –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞

```bash
# –í—Å—ë —É–¥–∞–ª–∏—Ç—å
make clean

# –ò–ª–∏ –≤—Ä—É—á–Ω—É—é
docker-compose down -v --rmi all
rm -rf output/ test-results/
```

## Windows (PowerShell)

```powershell
# –í–º–µ—Å—Ç–æ make –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ docker-compose –Ω–∞–ø—Ä—è–º—É—é
docker-compose up --build

# –ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ .ps1 —Å–∫—Ä–∏–ø—Ç—ã:
.\run-tests.ps1
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

| –û–ø–µ—Ä–∞—Ü–∏—è | –í—Ä–µ–º—è |
|----------|-------|
| –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ | ~30 —Å–µ–∫ |
| –ó–∞–ø—É—Å–∫ PostgreSQL | ~5 —Å–µ–∫ |
| –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ | ~15 —Å–µ–∫ |
| **–ò—Ç–æ–≥–æ** | **~1 –º–∏–Ω—É—Ç–∞** |

## –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

1. ‚úÖ –ó–∞–ø—É—Å–∫–∞–π—Ç–µ `make test` –ø–µ—Ä–µ–¥ –∫–æ–º–º–∏—Ç–æ–º
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ `test-results/summary.txt`
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `make clean` –º–µ–∂–¥—É –∑–∞–ø—É—Å–∫–∞–º–∏
4. ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ `output/` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
5. ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ –≤ CI/CD

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### –†–∞–∑–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ PostgreSQL

```yaml
# docker-compose.yml
postgres:
  image: postgres:15-alpine  # –∏–ª–∏ 14, 13
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö —Ç–µ—Å—Ç–æ–≤

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `docker-test.sh`:
```bash
run_test "–ú–æ–π —Ç–µ—Å—Ç" \
    "–∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
```

### –ö–∞—Å—Ç–æ–º–Ω–∞—è policy.yaml

```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π —Ñ–∞–π–ª
cp policy.yaml my-policy.yaml

# –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ
docker-compose run --rm pg-sec-lab generate \
  --policy /app/my-policy.yaml
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

‚úÖ **–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è  
‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é** - 15+ —Ç–µ—Å—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏  
‚úÖ **–í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å** - –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–∑–¥–µ  
‚úÖ **CI/CD –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è  
‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç—É** - –æ–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞  

–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ `make test` –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –æ—Ç—á—ë—Ç –æ —Ä–∞–±–æ—Ç–µ pg-sec-lab! üöÄ
