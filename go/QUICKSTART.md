# Быстрый старт с pg-sec-lab

## Шаг 1: Установка

```bash
# Клонировать репозиторий
git clone <your-repo>
cd course-4

# Собрать проект
go build -o pg-sec-lab.exe

# Проверить установку
./pg-sec-lab --help
```

## Шаг 2: Создать policy.yaml

Создайте файл `my-policy.yaml`:

```yaml
metadata:
  system: "my-app"
  version: "1.0"

tenants:
  enabled: true
  setting: "app.tenant_id"

roles:
  app_reader:
    login: true
    can_create_db: false
    privileges:
      - object: "public.users"
        actions: ["SELECT"]

tables:
  public.users:
    rls:
      enabled: true
      select_policy: "tenant_id = current_setting('app.tenant_id')::uuid"
```

## Шаг 3: Сгенерировать SQL

```bash
./pg-sec-lab generate --policy my-policy.yaml --out setup.sql
```

Результат в `setup.sql`:
```sql
-- Generated by pg-sec-lab
-- System: my-app, Version: 1.0

-- Create roles
CREATE ROLE "app_reader" LOGIN NOCREATEDB;

-- Enable RLS on tables
ALTER TABLE "public"."users" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "public"."users" FORCE ROW LEVEL SECURITY;
CREATE POLICY "rls_select_users" ON "public"."users" FOR SELECT USING (tenant_id = current_setting('app.tenant_id')::uuid);

-- Grant privileges
GRANT SELECT ON "public"."users" TO "app_reader";
```

## Шаг 4: Применить к базе данных

```bash
# Создать базу данных
createdb myapp

# Применить SQL
psql -d myapp -f setup.sql
```

## Шаг 5: Проверить политики

```bash
./pg-sec-lab verify \
  --policy my-policy.yaml \
  --dsn "postgres://postgres:password@localhost/myapp"
```

Вывод:
```
2024/12/01 15:30:00 Starting policy verification...
2024/12/01 15:30:00 Creating test schema: pg_sec_lab_test_12345
2024/12/01 15:30:01 Testing RLS for tenant A...
2024/12/01 15:30:01 ✅ Tenant A sees 2 rows (expected: 2)
2024/12/01 15:30:01 ✅ All verification checks passed!
```

## Шаг 6: Проанализировать конфигурацию

```bash
./pg-sec-lab analyze \
  --dsn "postgres://postgres:password@localhost/myapp" \
  --out report.json
```

Проверьте `report.json` для обнаруженных проблем безопасности.

## Что дальше?

- Изучите [EXAMPLES.md](EXAMPLES.md) для более сложных сценариев
- Прочитайте [ARCHITECTURE.md](ARCHITECTURE.md) для понимания внутреннего устройства
- Интегрируйте в CI/CD pipeline

## Общие задачи

### Добавить новую роль

1. Обновите `policy.yaml`:
```yaml
roles:
  new_role:
    login: true
    privileges:
      - object: "public.orders"
        actions: ["SELECT", "INSERT"]
```

2. Сгенерируйте SQL: `./pg-sec-lab generate --policy policy.yaml --out update.sql`
3. Примените: `psql -d myapp -f update.sql`

### Добавить маскировку данных

```yaml
tables:
  public.customers:
    masks:
      - column: "email"
        expression: "regexp_replace(email, '@.*$', '@***')"
        exposed_as: "customers_masked"
```

### Проверить существующую БД

```bash
./pg-sec-lab analyze --dsn "postgres://..." --out audit.json
cat audit.json | jq '.findings'
```

## Troubleshooting

**Проблема**: `permission denied for schema public`

**Решение**: Убедитесь, что пользователь имеет права:
```sql
GRANT ALL ON SCHEMA public TO your_user;
```

**Проблема**: `cannot execute CREATE POLICY in a read-only transaction`

**Решение**: Используйте пользователя с правами для DDL операций.

## Поддержка

- GitHub Issues: <your-repo>/issues
- Email: your-email@example.com
