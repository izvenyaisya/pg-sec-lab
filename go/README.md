# pg-sec-lab

üéâ **100% —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ!** ‚úÖ

CLI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é PostgreSQL —á–µ—Ä–µ–∑ Policy-as-Code –ø–æ–¥—Ö–æ–¥.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîê **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL –ø–æ–ª–∏—Ç–∏–∫** –∏–∑ –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ YAML —Ñ–∞–π–ª–∞
- ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫** –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- üìä **–ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** PostgreSQL —Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º JSON-–æ—Ç—á—ë—Ç–∞
- üõ°Ô∏è **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ RLS** (Row Level Security)
- üé≠ **–ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö** —á–µ—Ä–µ–∑ VIEW
- üë• **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏** –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏
- üê≥ **Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–µ** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –õ–æ–∫–∞–ª—å–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
go build -o pg-sec-lab.exe
```

### Docker (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
docker-compose up --build

# –ò–ª–∏ —Å Makefile
make test
```

–°–º. [DOCKER_QUICKSTART.md](DOCKER_QUICKSTART.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
pg-sec-lab/
‚îú‚îÄ‚îÄ cmd/                      # CLI –∫–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îú‚îÄ‚îÄ root.go              # –ö–æ—Ä–Ω–µ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
‚îÇ   ‚îú‚îÄ‚îÄ generate.go          # –ö–æ–º–∞–Ω–¥–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ SQL
‚îÇ   ‚îú‚îÄ‚îÄ verify.go            # –ö–æ–º–∞–Ω–¥–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–∏—Ç–∏–∫
‚îÇ   ‚îî‚îÄ‚îÄ analyze.go           # –ö–æ–º–∞–Ω–¥–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ policy/              # –ú–æ–¥–µ–ª—å –∏ –∑–∞–≥—Ä—É–∑—á–∏–∫ policy.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ model.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ loader.go
‚îÇ   ‚îú‚îÄ‚îÄ generator/           # –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä SQL
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ generator.go
‚îÇ   ‚îú‚îÄ‚îÄ verifier/            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ verifier.go
‚îÇ   ‚îî‚îÄ‚îÄ configcheck/         # –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL
‚îÇ       ‚îî‚îÄ‚îÄ configcheck.go
‚îú‚îÄ‚îÄ main.go                  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ go.mod
‚îî‚îÄ‚îÄ policy.yaml              # –ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –ø–æ–ª–∏—Ç–∏–∫–∏

```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### 1. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç SQL-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–æ–ª–µ–π, RLS –ø–æ–ª–∏—Ç–∏–∫ –∏ –º–∞—Å–∫–∏—Ä–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö:

```bash
./pg-sec-lab generate --policy policy.yaml --out output.sql
```

–ò–ª–∏ –≤—ã–≤–æ–¥ –≤ stdout:

```bash
./pg-sec-lab generate --policy policy.yaml
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫

–ü—Ä–∏–º–µ–Ω—è–µ—Ç –ø–æ–ª–∏—Ç–∏–∫–∏ –∫ —Ç–µ—Å—Ç–æ–≤–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏—Ö –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å:

```bash
./pg-sec-lab verify --policy policy.yaml --dsn "postgres://user:password@localhost:5432/testdb?sslmode=disable"
```

–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö tenant_id
- –†–æ–ª–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏
- –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Ç–µ–Ω–∞–Ω—Ç–∞–º–∏

### 3. –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PostgreSQL –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç JSON-–æ—Ç—á—ë—Ç:

```bash
./pg-sec-lab analyze --dsn "postgres://user:password@localhost:5432/mydb" --out report.json
```

–û—Ç—á—ë—Ç –≤–∫–ª—é—á–∞–µ—Ç:
- –í–µ—Ä—Å–∏—é PostgreSQL –∏ –∫–ª—é—á–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –°–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π —Å –∏—Ö –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏ –∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏
- –°–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–∫–ª—é—á—ë–Ω–Ω–æ–º RLS
- Findings (–æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

## –§–æ—Ä–º–∞—Ç policy.yaml

```yaml
metadata:
  system: "training-crm"
  version: "1.0"

tenants:
  enabled: true
  setting: "app.tenant_id"

roles:
  analyst:
    login: false
    members: [reporting_app]
    privileges:
      - object: "public.orders"
        actions: ["SELECT"]
      - object: "public.customers_masked"
        actions: ["SELECT"]

  reporting_app:
    login: true
    can_create_db: false

tables:
  public.customers:
    rls:
      enabled: true
      select_policy: "tenant_id = current_setting('app.tenant_id')::uuid"
    masks:
      - column: "email"
        expression: "regexp_replace(email, '@.*$', '@***')"
        exposed_as: "customers_masked"

  public.orders:
    rls:
      enabled: true
      select_policy: "tenant_id = current_setting('app.tenant_id')::uuid"
```

## –ü—Ä–∏–º–µ—Ä JSON-–æ—Ç—á—ë—Ç–∞

```json
{
  "instance": {
    "version": "PostgreSQL 16.1",
    "settings": {
      "ssl": "on",
      "password_encryption": "scram-sha-256",
      "log_connections": "on",
      "log_disconnections": "on",
      "log_statement": "all"
    }
  },
  "roles": [
    {
      "name": "reporting_app",
      "login": true,
      "superuser": false,
      "bypassrls": false,
      "grants": [
        "SELECT ON public.orders",
        "SELECT ON public.customers_masked"
      ]
    }
  ],
  "tables": [
    {
      "schema": "public",
      "name": "customers",
      "rls_enabled": true
    }
  ],
  "findings": [
    {
      "severity": "warning",
      "code": "NO_RLS",
      "message": "Table public.some_table has no RLS enabled"
    }
  ]
}
```

## –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **Go 1.21+**
- **github.com/spf13/cobra** - CLI framework
- **github.com/jackc/pgx/v5** - PostgreSQL –¥—Ä–∞–π–≤–µ—Ä
- **gopkg.in/yaml.v3** - YAML –ø–∞—Ä—Å–µ—Ä
- **github.com/google/uuid** - UUID –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä

## Docker Testing

–ü—Ä–æ–µ–∫—Ç –≤–∫–ª—é—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ Docker-–æ–∫—Ä—É–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã (15+ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫)
make test

# –ò–ª–∏ –±–µ–∑ Makefile
docker-compose up --build
```

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è:**
- ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL (stdout –∏ —Ñ–∞–π–ª)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ SQL
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ verify –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î
- ‚úÖ –ö–æ–º–∞–Ω–¥–∞ analyze —Å JSON-–æ—Ç—á—ë—Ç–æ–º
- ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –∫ PostgreSQL
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –∏ —Ä–æ–ª–µ–π

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- `output/generated.sql` - —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SQL
- `output/report.json` - JSON-–æ—Ç—á—ë—Ç –∞–Ω–∞–ª–∏–∑–∞
- `test-results/summary.txt` - –∏—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

–°–º. [DOCKER_QUICKSTART.md](DOCKER_QUICKSTART.md) –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1. **Policy-as-Code**: –î–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤ YAML
2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è SQL**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ SQL-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏–∑ –ø–æ–ª–∏—Ç–∏–∫
3. **–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è**: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–∏—Ç–∏–∫ –Ω–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ö–µ–º–µ
4. **–ê–Ω–∞–ª–∏–∑**: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ PostgreSQL

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã SQL —ç–∫—Ä–∞–Ω–∏—Ä—É—é—Ç—Å—è
- RLS –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ (FORCE ROW LEVEL SECURITY)
- –†–æ–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∏–≤–∏–ª–µ–≥–∏—è–º–∏
- –ú–∞—Å–∫–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ VIEW –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏

## –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- üìñ [README.md](README.md) - –û—Å–Ω–æ–≤–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- üöÄ [QUICKSTART.md](QUICKSTART.md) - –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
- üí° [EXAMPLES.md](EXAMPLES.md) - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- üèóÔ∏è [ARCHITECTURE.md](ARCHITECTURE.md) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- üê≥ [DOCKER_QUICKSTART.md](DOCKER_QUICKSTART.md) - Docker —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- üß™ [DOCKER_TESTING.md](DOCKER_TESTING.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Docker

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
